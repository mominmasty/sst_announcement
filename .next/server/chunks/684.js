exports.id=684,exports.ids=[684],exports.modules={6487:()=>{},8335:()=>{},1770:(e,t,n)=>{"use strict";n.a(e,async(e,r)=>{try{n.d(t,{Lf:()=>d,d_:()=>o});var s=n(4939),i=n(1214),a=n(3945),u=n(6980),l=e([s,i,u]);[s,i,u]=l.then?(await l)():l;let c=globalThis;function o(){if(c.pool)return c.pool;let e=(0,a.SL)(),t=new s.Pool({connectionString:e.DATABASE_URL,ssl:e.DATABASE_URL?.includes("localhost")?void 0:{rejectUnauthorized:!1}});return c.pool=t,t}function d(){if(c.db)return c.db;let e=o(),t=(0,i.drizzle)(e,{schema:u});return c.db=t,t}r()}catch(e){r(e)}})},3945:(e,t,n)=>{"use strict";n.d(t,{SL:()=>i,Un:()=>a});let r=["DATABASE_URL","SESSION_SECRET","CLERK_SECRET_KEY"],s=!1;function i(){if(s)return a();let e=[];for(let t of r)process.env[t]||e.push(t);if(e.length>0){let t=`Missing required environment variables: ${e.join(", ")}`;throw console.error("âŒ Environment validation failed"),console.error(t),Error(t)}return s=!0,a()}function a(){return{DATABASE_URL:"postgresql://sst_database_user:zefoqA6HXo616kXZMyWl8BXlkQBPIqx2@dpg-d3t8nve3jp1c738js3l0-a.oregon-postgres.render.com/sst_database",SESSION_SECRET:"testsessionsecret",CLERK_SECRET_KEY:"sk_test_d5FnQ6CDfpTB1mKdjveMGUdiCVAfs3OdAg4XIH0ZCf",JWT_SECRET:"devsecret123",FRONTEND_URL:"http://localhost:3000",BACKEND_URL:"http://localhost:8787",GOOGLE_CLIENT_ID:process.env.GOOGLE_CLIENT_ID,GOOGLE_CLIENT_SECRET:process.env.GOOGLE_CLIENT_SECRET,GOOGLE_CALLBACK_URL:process.env.GOOGLE_CALLBACK_URL,RESEND_API_KEY:"re_2Kn711pT_CjTUiSrn7JXCoqV9hgXECpKc",RESEND_FROM_EMAIL:"onboarding@resend.dev",DEPLOYMENT:"local",CRON_SECRET:"replace_me_with_random_string"}}},4172:(e,t,n)=>{"use strict";n.a(e,async(e,r)=>{try{n.d(t,{CF:()=>o,aF:()=>m,cz:()=>d,kl:()=>l,v_:()=>c});var s=n(1737),i=n(1770),a=n(6980),u=e([s,i,a]);async function l(e){let t=(0,i.Lf)(),[n]=await t.select().from(a.users).where((0,s.eq)(a.users.id,e)).limit(1);return n?m(n):null}async function o(){let e=(0,i.Lf)();return(await e.select({id:a.users.id,clerkId:a.users.clerkId,email:a.users.email,username:a.users.username,role:a.users.role,createdAt:a.users.createdAt,lastLogin:a.users.lastLogin}).from(a.users).orderBy((0,s.desc)(a.users.createdAt))).map(e=>({id:e.id,clerk_id:e.clerkId,email:e.email,username:e.username,role:e.role||"student",is_admin:"admin"===e.role||"super_admin"===e.role||"student_admin"===e.role,created_at:e.createdAt,last_login:e.lastLogin}))}async function d(e,t){return c(e,t?"admin":"student")}async function c(e,t){let n=(0,i.Lf)(),[r]=await n.update(a.users).set({role:t}).where((0,s.eq)(a.users.id,e)).returning();if(!r)throw Error("User not found");return m(r)}function m(e){let t=e.role||"user";return{id:e.id,clerk_id:e.clerkId,email:e.email,username:e.username,role:t,is_admin:"admin"===t||"super_admin"===t||"student_admin"===t,created_at:e.createdAt,last_login:e.lastLogin}}[s,i,a]=u.then?(await u)():u,r()}catch(e){r(e)}})},4272:(e,t,n)=>{"use strict";n.a(e,async(e,r)=>{try{n.d(t,{Kv:()=>m,ZT:()=>c,oC:()=>d});var s=n(4218),i=n(366),a=n(6793),u=n(1508),l=e([a]);async function o(e){let t=function(e){let t=e.headers.get("authorization");return t&&t.startsWith("Bearer ")?t.substring(7):null}(e)??function(e){let t=e.cookies.get("__session");return t?.value||null}(e);if(!t)return null;let n=await (0,a.Q)(t);return n?await (0,a.I)(n):null}async function d(e,t){let n=await o(e);if(!n)throw new s.D_("Authentication required");return t?.enforceDomain&&(0,i.eU)(n),n}function c(e){if(!function(e){let t=(0,u.t9)(e.role,e.is_admin);return["student_admin","admin","super_admin"].includes(t)}(e))throw new s.qQ("This resource requires admin access")}function m(e){(function(e,t){let n={student:1,student_admin:2,admin:2,super_admin:3};if((n[(0,u.t9)(e.role,e.is_admin)]??1)<n[t])throw new s.qQ(`This resource requires ${t} role or higher`)})(e,"super_admin")}a=(l.then?(await l)():l)[0],r()}catch(e){r(e)}})},366:(e,t,n)=>{"use strict";n.d(t,{eU:()=>i});var r=n(4218);let s=["scaler.com","sst.scaler.com"];function i(e){if(!e)throw new r.D_("Authentication required");if(!e.email)throw new r.qQ("Invalid user");if(!function(e){let t=function(e){if(!e||"string"!=typeof e)return null;let t=e.split("@");return 2!==t.length?null:t[1].toLowerCase()}(e);return!!t&&s.includes(t)}(e.email))throw new r.qQ("Domain access restricted")}},6980:(e,t,n)=>{"use strict";n.a(e,async(e,r)=>{try{n.r(t),n.d(t,{announcementComments:()=>_,announcementCommentsRelations:()=>E,announcementEngagements:()=>m,announcementEngagementsRelations:()=>p,announcementStatusEnum:()=>o,announcements:()=>c,announcementsRelations:()=>h,eventTypeEnum:()=>l,userRoleEnum:()=>u,users:()=>d,usersRelations:()=>f});var s=n(8025),i=n(1737),a=e([s,i]);[s,i]=a.then?(await a)():a;let u=(0,s.pgEnum)("user_role",["student","student_admin","admin","super_admin","user"]),l=(0,s.pgEnum)("event_type",["view","click","dismiss"]),o=(0,s.pgEnum)("announcement_status",["draft","under_review","approved","rejected","scheduled","active","urgent","expired"]),d=(0,s.pgTable)("users",{id:(0,s.serial)("id").primaryKey(),clerkId:(0,s.text)("clerk_id").notNull().unique(),email:(0,s.text)("email").notNull().unique(),username:(0,s.varchar)("username",{length:100}),role:u("role").default("student").notNull(),createdAt:(0,s.timestamp)("created_at",{withTimezone:!0}).defaultNow(),lastLogin:(0,s.timestamp)("last_login",{withTimezone:!0})}),c=(0,s.pgTable)("announcements",{id:(0,s.serial)("id").primaryKey(),title:(0,s.varchar)("title",{length:255}).notNull(),description:(0,s.text)("description").notNull(),category:(0,s.varchar)("category",{length:100}).notNull(),authorId:(0,s.integer)("author_id").references(()=>d.id,{onDelete:"set null"}),createdAt:(0,s.timestamp)("created_at",{withTimezone:!0}).defaultNow(),updatedAt:(0,s.timestamp)("updated_at",{withTimezone:!0}),expiryDate:(0,s.timestamp)("expiry_date",{withTimezone:!0}),scheduledAt:(0,s.timestamp)("scheduled_at",{withTimezone:!0}),reminderTime:(0,s.timestamp)("reminder_time",{withTimezone:!0}),isActive:(0,s.boolean)("is_active").default(!0),status:o("status").default("draft").notNull(),viewsCount:(0,s.integer)("views_count").default(0),clicksCount:(0,s.integer)("clicks_count").default(0),sendEmail:(0,s.boolean)("send_email").default(!1),emailSent:(0,s.boolean)("email_sent").default(!1),priorityUntil:(0,s.timestamp)("priority_until",{withTimezone:!0}),isEmergency:(0,s.boolean)("is_emergency").default(!1).notNull(),emergencyExpiresAt:(0,s.timestamp)("emergency_expires_at",{withTimezone:!0}),visibleAfter:(0,s.timestamp)("visible_after",{withTimezone:!0})}),m=(0,s.pgTable)("announcement_engagements",{id:(0,s.serial)("id").primaryKey(),announcementId:(0,s.integer)("announcement_id").notNull().references(()=>c.id,{onDelete:"cascade"}),userId:(0,s.integer)("user_id").references(()=>d.id,{onDelete:"set null"}),eventType:(0,s.text)("event_type").notNull(),createdAt:(0,s.timestamp)("created_at",{withTimezone:!0}).defaultNow()}),_=(0,s.pgTable)("announcement_comments",{id:(0,s.serial)("id").primaryKey(),announcementId:(0,s.integer)("announcement_id").notNull().references(()=>c.id,{onDelete:"cascade"}),authorId:(0,s.integer)("author_id").notNull().references(()=>d.id,{onDelete:"cascade"}),targetAdminId:(0,s.integer)("target_admin_id").notNull().references(()=>d.id,{onDelete:"cascade"}),content:(0,s.text)("content").notNull(),createdAt:(0,s.timestamp)("created_at",{withTimezone:!0}).defaultNow().notNull()}),f=(0,i.relations)(d,({many:e})=>({announcements:e(c),engagements:e(m)})),h=(0,i.relations)(c,({one:e,many:t})=>({author:e(d,{fields:[c.authorId],references:[d.id]}),engagements:t(m)})),p=(0,i.relations)(m,({one:e})=>({announcement:e(c,{fields:[m.announcementId],references:[c.id]}),user:e(d,{fields:[m.userId],references:[d.id]})})),E=(0,i.relations)(_,({one:e})=>({announcement:e(c,{fields:[_.announcementId],references:[c.id]}),author:e(d,{fields:[_.authorId],references:[d.id]}),targetAdmin:e(d,{fields:[_.targetAdminId],references:[d.id]})}));r()}catch(e){r(e)}})},6793:(e,t,n)=>{"use strict";n.a(e,async(e,r)=>{try{n.d(t,{I:()=>_,Q:()=>m});var s=n(6056),i=n(1737),a=n(3945),u=n(1770),l=n(6980),o=n(4172),d=e([i,u,l,o]);[i,u,l,o]=d.then?(await d)():d;let f=null,h=null;function c(){if(f)return f;let e=(0,a.Un)();if(!e.CLERK_SECRET_KEY)throw Error("CLERK_SECRET_KEY is not configured");return f=e.CLERK_SECRET_KEY}async function m(e){try{return await (0,s.n)(e,{secretKey:c()})}catch(e){return console.warn("Clerk token verification failed:",e),null}}async function _(e){let t=(0,u.Lf)(),n=e.sub;if(!n)throw Error("Clerk token missing subject");let r=e.email,a=e.username||e.first_name||e.last_name||null;if(!r){let e=h||(h=(0,s.z)({secretKey:c()})),t=await e.users.getUser(n);if(!(r=t.emailAddresses.find(e=>e.id===t.primaryEmailAddressId)?.emailAddress))throw Error("Clerk user has no email address");a=t.username||t.firstName||t.lastName||null}let[d]=await t.select().from(l.users).where((0,i.eq)(l.users.clerkId,n)).limit(1);if(d){if(d.email!==r||d.username!==a||!d.lastLogin||Date.now()-new Date(d.lastLogin).getTime()>36e5){let[e]=await t.update(l.users).set({email:r,username:a??d.username,lastLogin:new Date}).where((0,i.eq)(l.users.id,d.id)).returning();return(0,o.aF)(e??d)}return(0,o.aF)(d)}let[m]=await t.select().from(l.users).where((0,i.eq)(l.users.email,r)).limit(1);if(m){let[e]=await t.update(l.users).set({clerkId:n,username:a??m.username,lastLogin:new Date}).where((0,i.eq)(l.users.id,m.id)).returning();return(0,o.aF)(e)}let[_]=await t.insert(l.users).values({clerkId:n,email:r,username:a,role:"user",lastLogin:new Date}).returning();return(0,o.aF)(_)}r()}catch(e){r(e)}})},4218:(e,t,n)=>{"use strict";n.d(t,{D_:()=>a,m_:()=>s,qQ:()=>u,v7:()=>i});class r extends Error{constructor(e,t,n,r){super(t),this.name="ApiError",this.statusCode=e,this.code=n,this.details=r}}class s extends r{constructor(e,t){super(404,`${e}${t?` with id ${t}`:""} not found`,"NOT_FOUND")}}class i extends r{constructor(e,t){super(400,e,"BAD_REQUEST",t)}}class a extends r{constructor(e="Unauthorized"){super(401,e,"UNAUTHORIZED")}}class u extends r{constructor(e="Forbidden"){super(403,e,"FORBIDDEN")}}},1508:(e,t,n)=>{"use strict";function r(e,t){return e&&({user:"student",superadmin:"super_admin",student:"student",student_admin:"student_admin",admin:"admin",super_admin:"super_admin"})[e]||(t?"admin":"student")}function s(e){return["student_admin","admin","super_admin"].includes(e)}n.d(t,{t9:()=>r,uu:()=>s})}};